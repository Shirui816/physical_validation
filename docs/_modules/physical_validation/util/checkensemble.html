

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>physical_validation.util.checkensemble &mdash; physical_validation 0.9b documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="physical_validation 0.9b documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> physical_validation
          

          
          </a>

          
            
            
              <div class="version">
                0.9b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide.html#examples-folder"><cite>examples/</cite> folder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide.html#simulation-data">Simulation data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide.html#kinetic-energy-validation">Kinetic energy validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide.html#ensemble-validation">Ensemble validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide.html#integrator-validation">Integrator Validation</a></li>
</ul>
<p class="caption"><span class="caption-text">Data format and parsers:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../parsers.html"><code class="docutils literal"><span class="pre">SimulationData</span></code> objects and parsers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parsers.html#data-contained-in-simulationdata-objects">Data contained in <code class="docutils literal"><span class="pre">SimulationData</span></code> objects</a></li>
</ul>
<p class="caption"><span class="caption-text">Package reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../physical_validation.html">physical_validation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physical_validation.data.html">physical_validation.data subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physical_validation.util.html">physical_validation.util subpackage</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">physical_validation</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>physical_validation.util.checkensemble</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for physical_validation.util.checkensemble</h1><div class="highlight"><pre>
<span></span><span class="c1">###########################################################################</span>
<span class="c1">#                                                                         #</span>
<span class="c1">#    physical_validation,                                                 #</span>
<span class="c1">#    a python package to test the physical validity of MD results         #</span>
<span class="c1">#                                                                         #</span>
<span class="c1">#    Written by Michael R. Shirts &lt;michael.shirts@colorado.edu&gt;           #</span>
<span class="c1">#               Pascal T. Merz &lt;pascal.merz@colorado.edu&gt;                 #</span>
<span class="c1">#                                                                         #</span>
<span class="c1">#    Copyright (C) 2012 University of Virginia                            #</span>
<span class="c1">#              (C) 2017 University of Colorado Boulder                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1">#    This library is free software; you can redistribute it and/or        #</span>
<span class="c1">#    modify it under the terms of the GNU Lesser General Public           #</span>
<span class="c1">#    License as published by the Free Software Foundation; either         #</span>
<span class="c1">#    version 2.1 of the License, or (at your option) any later version.   #</span>
<span class="c1">#                                                                         #</span>
<span class="c1">#    This library is distributed in the hope that it will be useful,      #</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of       #</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    #</span>
<span class="c1">#    Lesser General Public License for more details.                      #</span>
<span class="c1">#                                                                         #</span>
<span class="c1">#    You should have received a copy of the GNU Lesser General Public     #</span>
<span class="c1">#    License along with this library; if not, write to the                #</span>
<span class="c1">#    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,     #</span>
<span class="c1">#    Boston, MA 02110-1301 USA                                            #</span>
<span class="c1">#                                                                         #</span>
<span class="c1">###########################################################################</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file largely corresponds to the checkensemble.py code originally</span>
<span class="sd">published on https://github.com/shirtsgroup/checkensemble. It now serves</span>
<span class="sd">as the low-level functionality of the high-level module</span>
<span class="sd">:mod:`physical_validation.ensemble`.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">numpy.random</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">plot</span>

<span class="c1">#==========================</span>
<span class="c1"># HELPER FUNCTIONS</span>
<span class="c1">#=========================</span>

<div class="viewcode-block" id="check_twodtype"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.check_twodtype">[docs]</a><span class="k">def</span> <span class="nf">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>  <span class="c1"># check if it&#39;s a valid type</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="o">==</span><span class="s1">&#39;dbeta-dpressure&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="o">==</span><span class="s1">&#39;dbeta-dmu&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="o">==</span><span class="s1">&#39;dbeta-ddmu&#39;</span><span class="p">):</span>
        <span class="c1">#print &#39;Warning: can\&#39;t do 3D fits currently&#39; </span>
    <span class="c1"># throw an exception?</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PrepConversionFactors"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.PrepConversionFactors">[docs]</a><span class="k">def</span> <span class="nf">PrepConversionFactors</span><span class="p">(</span><span class="n">eunits</span><span class="o">=</span><span class="s1">&#39;kJ/mol&#39;</span><span class="p">,</span><span class="n">punits</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="n">vunits</span><span class="o">=</span><span class="s1">&#39;nm^3&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">vunits</span> <span class="o">==</span> <span class="s1">&#39;nm^3&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">punits</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">):</span>
    <span class="c1"># default conversion is gromacs nm3*bar to kJ/mol</span>
    <span class="c1"># 1 nm3.bar = 0.00060221415 m3.bar / mol, 0.01 m3.bar/mol = 1 kJ/mol --&gt; 6.0221415x10^-2 kJ/mol / nm3/bar</span>
        <span class="n">pvconvert</span> <span class="o">=</span> <span class="mf">0.06221415</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">vunits</span> <span class="o">==</span> <span class="s1">&#39;kT&#39;</span> <span class="ow">and</span> <span class="n">punits</span> <span class="o">==</span> <span class="s1">&#39;kT&#39;</span><span class="p">):</span>
        <span class="n">pvconvert</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I don&#39;t know the conversion factor for </span><span class="si">%s</span><span class="s2"> volume units and </span><span class="si">%s</span><span class="s2"> pressure units&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vunits</span><span class="p">,</span><span class="n">punits</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">eunits</span> <span class="o">==</span> <span class="s1">&#39;kJ/mol&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">eunits</span> <span class="o">==</span> <span class="s1">&#39;kT&#39;</span><span class="p">):</span>    
        <span class="n">econvert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">eunits</span> <span class="o">==</span> <span class="s1">&#39;kcal/mol&#39;</span><span class="p">):</span>
        <span class="n">pvconvert</span> <span class="o">/=</span> <span class="mf">4.184</span>  <span class="c1"># if eunits are in kcal/mol, then we need to change pconvert to kcal/mol / nm3/bar</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I don&#39;t know those energy units&quot;</span><span class="p">)</span>

    <span class="n">muconvert</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">econvert</span>    
    <span class="k">return</span> <span class="n">econvert</span><span class="p">,</span><span class="n">pvconvert</span><span class="p">,</span><span class="n">muconvert</span>    </div>


<div class="viewcode-block" id="prepare_conversion_factors"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.prepare_conversion_factors">[docs]</a><span class="k">def</span> <span class="nf">prepare_conversion_factors</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
    <span class="c1"># GROMACS standard units are</span>
    <span class="c1">#   energy: kJ/mol</span>
    <span class="c1">#   volume: nm^3</span>
    <span class="c1">#   pressure: bar</span>
    <span class="c1">#   =&gt; pV-term: bar * nm^3 == 1e-25 kJ == 6.022140857e-2 kJ/mol</span>
    <span class="c1">#   =&gt; pvconvert = 6.022140857e-2</span>

    <span class="n">econvert</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pvconvert</span> <span class="o">=</span> <span class="mf">6.022140857e-2</span>

    <span class="c1"># UnitData stores conversion factors relative to GROMACS units</span>
    <span class="c1">#   energy: energy_conversion * kJ/mol</span>
    <span class="c1">#   volume: volume_conversion * nm^3</span>
    <span class="c1">#   pressure: pressure_conversion * bar</span>
    <span class="c1">#   =&gt; pV-term: [p]*[V] == pressure_conversion * volume_conversion bar * nm^3</span>
    <span class="n">pvconvert</span> <span class="o">*=</span> <span class="n">units</span><span class="o">.</span><span class="n">pressure_conversion</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">volume_conversion</span>
    <span class="n">pvconvert</span> <span class="o">/=</span> <span class="n">units</span><span class="o">.</span><span class="n">energy_conversion</span>

    <span class="c1"># TODO: check this once muVT is implemented</span>
    <span class="n">muconvert</span> <span class="o">=</span> <span class="o">-</span><span class="n">econvert</span>

    <span class="k">return</span> <span class="n">econvert</span><span class="p">,</span> <span class="n">pvconvert</span><span class="p">,</span> <span class="n">muconvert</span></div>


<div class="viewcode-block" id="PrepStrings"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.PrepStrings">[docs]</a><span class="k">def</span> <span class="nf">PrepStrings</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span><span class="n">vunits</span><span class="o">=</span><span class="s1">&#39;kT&#39;</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-constV&#39;</span><span class="p">):</span>
        <span class="n">vt</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
        <span class="n">plinfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$-(\beta_2-\beta_1)E$&#39;</span>
        <span class="n">pnlfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\exp(-(\beta_2-\beta_1)E)$&#39;</span>
        <span class="n">varstring</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$E (kT)$&#39;</span>
        <span class="n">legend_location</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-constP&#39;</span><span class="p">):</span>    
        <span class="n">vt</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span>
        <span class="n">plinfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$-(\beta_2-\beta_1)H$&#39;</span>
        <span class="n">pnlfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\exp(-(\beta_2-\beta_1)H)$&#39;</span>
        <span class="n">varstring</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$H (kT)$&#39;</span>
        <span class="n">legend_location</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-constmu&#39;</span><span class="p">):</span>    
        <span class="c1">#averages are A = &lt;E&gt;-mu&lt;N&gt;. </span>
        <span class="n">vt</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
        <span class="n">plinfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$-(\beta_2-\beta_1)A$&#39;</span>
        <span class="n">pnlfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\exp(-(\beta_2-\beta_1)A)$&#39;</span>
        <span class="n">varstring</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$A (kT)$&#39;</span>
        <span class="n">legend_location</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-constdmu&#39;</span><span class="p">):</span>    
        <span class="c1">#averages are &lt;E&gt;-dmu&lt;N&gt;. </span>
        <span class="n">vt</span> <span class="o">=</span> <span class="s1">&#39;\langle E </span><span class="se">\r</span><span class="s1">angle - \Delta \mu \langle N_2</span><span class="se">\r</span><span class="s1">angle&#39;</span>
        <span class="n">plinfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$-(\beta_2-\beta_1)A$&#39;</span>
        <span class="n">pnlfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\exp(-(\beta_2-\beta_1)A)$&#39;</span>
        <span class="n">varstring</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$A (kT)$&#39;</span>
        <span class="n">legend_location</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dpressure-constB&#39;</span><span class="p">):</span>    
        <span class="n">vt</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
        <span class="n">plinfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$-\beta(P_2-P_1)V$&#39;</span>
        <span class="n">pnlfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\exp(-\beta(P_2-P_1)V)$&#39;</span>
        <span class="n">varstring</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$V (&#39;</span> <span class="o">+</span> <span class="n">vunits</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)$&#39;</span>
        <span class="n">legend_location</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dmu-constB&#39;</span><span class="p">):</span>    
        <span class="n">vt</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
        <span class="n">plinfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\beta(\mu_2-\mu_1)N$&#39;</span>
        <span class="n">pnlfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\exp(\beta(\mu_2-\mu_1)N)$&#39;</span>
        <span class="n">varstring</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$N (&#39;</span> <span class="o">+</span> <span class="s1">&#39;number&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)$&#39;</span>
        <span class="n">legend_location</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;ddmu-constB&#39;</span><span class="p">):</span>    
        <span class="n">vt</span> <span class="o">=</span> <span class="s1">&#39;N_2&#39;</span>
        <span class="n">plinfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\beta(\Delta \mu_2-\ Delta \mu_1)N_2$&#39;</span>
        <span class="n">pnlfit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\exp(\beta(\Delta \mu_2-\Delta \mu_1)N)_2$&#39;</span>
        <span class="n">varstring</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$N (&#39;</span> <span class="o">+</span> <span class="s1">&#39;number&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)$&#39;</span>
        <span class="n">legend_location</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dpressure&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dmu&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-ddmu&#39;</span><span class="p">):</span>    
        <span class="n">vt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">plinfit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">pnlfit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">varstring</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">legend_location</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Type is not defined for plotting!&quot;</span><span class="p">)</span>

    <span class="n">pstring</span> <span class="o">=</span> <span class="s1">&#39;ln(P_2(&#39;</span> <span class="o">+</span> <span class="n">vt</span> <span class="o">+</span> <span class="s1">&#39;)/P_1(&#39;</span> <span class="o">+</span> <span class="n">vt</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span>
    
    <span class="k">return</span> <span class="n">vt</span><span class="p">,</span><span class="n">pstring</span><span class="p">,</span><span class="n">plinfit</span><span class="p">,</span><span class="n">pnlfit</span><span class="p">,</span><span class="n">varstring</span><span class="p">,</span><span class="n">legend_location</span>       </div>
        

<div class="viewcode-block" id="PrepInputs"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.PrepInputs">[docs]</a><span class="k">def</span> <span class="nf">PrepInputs</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span><span class="n">conversions</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;dbeta-constV&#39;</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">beta_ave</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">P_ave</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mu_ave</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">U_kn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">V_kn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">N_kn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    useg can be either &quot;scale&quot;, where uncertainties are scaled, or &quot;subsample&quot; resulting in subsampled data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pvconvert</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># convenience variables </span>
    <span class="n">N0</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">maxN</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">N_k</span><span class="p">);</span>

    <span class="c1"># Currently seven types; fitting parameters are: </span>
    <span class="c1"># NVT</span>
    <span class="c1"># 1) free energy, dbeta, no P, N  - constants are beta_ave, variables (vectors) are E </span>
    <span class="c1"># NPT</span>
    <span class="c1"># 2) free energy, dpressure - constants are p_ave, variables (vectors) are V  </span>
    <span class="c1"># 3) free energy, dbeta, constP  - constants are beta_ave, variables (vectors) are H </span>
    <span class="c1"># 4) free energy, dbeta, dpressure - constants are beta_ave, p_ave, variables (vectors) are E and V</span>
    <span class="c1"># muPT</span>
    <span class="c1"># 5) free energy, dmu = constants are mu_ave, variables (vectors) are N</span>
    <span class="c1"># 6) free energy, dbeta, constmu  - constants are beta_ave, variables (vectors) are A </span>
    <span class="c1"># 7) free energy, dbeta, dmu - constants are beta_ave, mu_ave, variables (vectors) are E and N</span>
    <span class="c1">#</span>
    <span class="c1"># 8) free energy, ddmu = constants are dmu_ave, variables (vectors) are N_2</span>
    <span class="c1"># 9) free energy, dbeta, constdmu = constants are beta_ave, variables (vectors) are E-\delta\mu\N</span>
    <span class="c1"># 10) free energy, dbeta, ddmu - constants are beta_ave, dmu_ave, variables (vectors) are E and N_2</span>

    <span class="c1"># NVT types</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-constV&#39;</span><span class="p">):</span>
        <span class="c1"># allocate space </span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>        <span class="c1"># the variables  </span>
        <span class="n">vr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>             <span class="c1"># parameter constants</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>                <span class="c1"># &quot;true&quot; change in constants</span>

        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># NPT types    </span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-constP&#39;</span><span class="p">):</span>
        <span class="c1"># allocate space </span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>        <span class="c1"># the variables  </span>
        <span class="n">vr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>             <span class="c1"># parameter constants</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>                <span class="c1"># &quot;true&quot; change in constants</span>

        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">+</span> <span class="n">conversions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P_ave</span><span class="o">*</span><span class="n">V_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>  <span class="c1"># everything goes into energy units</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">+</span> <span class="n">conversions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P_ave</span><span class="o">*</span><span class="n">V_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dpressure-constB&#39;</span><span class="p">):</span>    
        <span class="c1"># allocate space </span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">vr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">V_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">V_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">pvconvert</span><span class="o">*</span><span class="n">beta_ave</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># units of 1/volume</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvconvert</span><span class="o">*</span><span class="n">beta_ave</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>   <span class="c1"># units of 1/volume</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dpressure&#39;</span><span class="p">):</span>    
        <span class="c1"># allocate space </span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">vr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">V_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">V_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># units of 1/E</span>
        <span class="n">const</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">pvconvert</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># units of E/V?</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># units of 1/Energy</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvconvert</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># units of 1/Volume</span>

<span class="c1"># mu V T types         </span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-constmu&#39;</span><span class="p">):</span>
        <span class="c1"># allocate space </span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>        <span class="c1"># the variables  </span>
        <span class="n">vr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>             <span class="c1"># parameter constants</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>                <span class="c1"># &quot;true&quot; change in constants</span>

        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu_ave</span><span class="o">*</span><span class="n">N_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>  <span class="c1"># everything goes into energy units</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu_ave</span><span class="o">*</span><span class="n">N_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>  <span class="c1"># everything is in energy units. </span>
        <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dmu-constB&#39;</span><span class="p">):</span>    
        <span class="c1"># allocate space </span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">vr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">beta_ave</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># units of 1/energy?</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">beta_ave</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>   <span class="c1"># units of 1/energy?</span>
        
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dmu&#39;</span><span class="p">):</span>    
        <span class="c1"># allocate space </span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">vr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">maxN</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># units of 1/E</span>
        <span class="n">const</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># units of E/V?</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># units of 1/Energy</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># units of 1/number?</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  Type of analysis </span><span class="si">%s</span><span class="s2"> is not defined!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">vr</span></div>

<div class="viewcode-block" id="LogLikelihood"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.LogLikelihood">[docs]</a><span class="k">def</span> <span class="nf">LogLikelihood</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">N0</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span>  <span class="o">=</span> <span class="n">N0</span><span class="o">+</span><span class="n">N1</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mf">1.0</span><span class="o">*</span><span class="n">N1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">N0</span><span class="p">))</span>

    <span class="c1">#D0 = M + beta_ave*x[0] + U0*x[1]</span>
    <span class="c1">#D1 = M + beta_ave*x[0] + U1*x[1]</span>

    <span class="n">D0</span> <span class="o">=</span> <span class="n">D1</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">D0</span> <span class="o">=</span> <span class="n">D0</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">D1</span> <span class="o">=</span> <span class="n">D1</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># old version:</span>
    <span class="c1"># E0 = 1 + numpy.exp(D0)</span>
    <span class="c1"># E1 = 1 + numpy.exp(-D1)</span>
    <span class="c1">#</span>
    <span class="c1"># # this is the negative of the log likelihood, since we want to maximize it using fmin</span>
    <span class="c1">#</span>
    <span class="c1"># of = ((numpy.sum(numpy.log(E0)) + numpy.sum(numpy.log(E1)))) / N</span>

    <span class="k">def</span> <span class="nf">log_1_plus_exp</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">yy</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">numpy</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">over</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">yy</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">xx</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">E0</span> <span class="o">=</span> <span class="n">log_1_plus_exp</span><span class="p">(</span><span class="n">D0</span><span class="p">)</span>
    <span class="n">E1</span> <span class="o">=</span> <span class="n">log_1_plus_exp</span><span class="p">(</span><span class="o">-</span><span class="n">D1</span><span class="p">)</span>

    <span class="c1"># this is the negative of the log likelihood, since we want to maximize it using fmin</span>

    <span class="n">of</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">E0</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">E1</span><span class="p">))</span> <span class="o">/</span> <span class="n">N</span>

    <span class="k">return</span> <span class="n">of</span></div>

<div class="viewcode-block" id="dLogLikelihood"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.dLogLikelihood">[docs]</a><span class="k">def</span> <span class="nf">dLogLikelihood</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Derivative with respect to the parameters, to aid the minimization.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">N0</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span>  <span class="o">=</span> <span class="n">N0</span><span class="o">+</span><span class="n">N1</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mf">1.0</span><span class="o">*</span><span class="n">N1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">N0</span><span class="p">))</span>

    <span class="n">D0</span> <span class="o">=</span> <span class="n">D1</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">D0</span> <span class="o">=</span> <span class="n">D0</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">D1</span> <span class="o">=</span> <span class="n">D1</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># old version:</span>
    <span class="c1"># E0 = 1/(1 + numpy.exp(-D0))</span>
    <span class="c1"># E1 = 1/(1 + numpy.exp(D1))</span>

    <span class="k">def</span> <span class="nf">inv_1_plus_exp</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">yy</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">numpy</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">over</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">return</span> <span class="n">xx</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">E0</span> <span class="o">=</span> <span class="n">inv_1_plus_exp</span><span class="p">(</span><span class="o">-</span><span class="n">D0</span><span class="p">)</span>
    <span class="n">E1</span> <span class="o">=</span> <span class="n">inv_1_plus_exp</span><span class="p">(</span><span class="n">D1</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1">#this is the gradient of -log likelihood</span>
    <span class="c1">#g[0] = (1.0/N)*(numpy.sum(beta*E0) - numpy.sum(beta*E1))</span>
    <span class="c1">#g[1] = (1.0/N)*(numpy.sum(U0*E0) - numpy.sum(U1*E1))</span>
    <span class="c1">#g[2] = (1.0/N)*(numpy.sum(V0*E0) - numpy.sum(V1*E1))</span>

    <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">E0</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">E1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span><span class="o">*</span><span class="n">E0</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span><span class="o">*</span><span class="n">E1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">g</span></div>

<div class="viewcode-block" id="d2LogLikelihood"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.d2LogLikelihood">[docs]</a><span class="k">def</span> <span class="nf">d2LogLikelihood</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    beta = const[0]</span>
<span class="sd">    pave = const[1]</span>

<span class="sd">    if D = M + beta*x[0] + x[1]*U</span>
<span class="sd">    I = \sum_{i=1}^N [[-beta^2/S,-beta*U/S],[-beta*U/S,-U^2/S]] where S = [(1+exp(-D))*(1+exp(D))]</span>

<span class="sd">    if D = M + beta*x[0] + x[1]*U + x[2]*V</span>
<span class="sd">    I = \sum_{i=1}^N [[-beta^2/S,-beta*U/S,-beta*V/S],[-beta*U/S,-U^2/S,-U*V/S],[-beta*V/S,-U*V^2/S,-V^2/S]] where S = [(1+exp(-D))*(1+exp(D))]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">N0</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span>  <span class="o">=</span> <span class="n">N0</span><span class="o">+</span><span class="n">N1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mf">1.0</span><span class="o">*</span><span class="n">N1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">N0</span><span class="p">))</span>

    <span class="n">vall</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">vall</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N0</span><span class="p">]</span>
        <span class="n">vall</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">N0</span><span class="p">:</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N1</span><span class="p">]</span>
    
    <span class="n">D</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="n">vall</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">hf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">L</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">N</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">cones</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># fix this to match the     </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">cones</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">a</span> <span class="o">=</span> <span class="n">vall</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
                <span class="n">b</span> <span class="o">=</span> <span class="n">cones</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">vall</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>    
            <span class="n">hf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span>

    <span class="k">def</span> <span class="nf">log_E</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">yy</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">numpy</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">over</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">yy</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">yy</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">yy</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="o">-</span><span class="n">yy</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">yy</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">yy</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1">#E = (1 + numpy.exp(-D)) * (1 + numpy.exp(D))</span>
    <span class="n">hf_E</span> <span class="o">=</span> <span class="n">hf</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">log_E</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>

    <span class="c1"># this is the hessian of the minimum function (not the max)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hf_E</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">N</span>
                            
    <span class="k">return</span> <span class="n">h</span></div>

<div class="viewcode-block" id="SolveMaxLike"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.SolveMaxLike">[docs]</a><span class="k">def</span> <span class="nf">SolveMaxLike</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">N_k</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="n">converge</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">itol</span> <span class="o">=</span> <span class="mf">1e-2</span>
    <span class="n">rtol</span> <span class="o">=</span> <span class="mf">1e-2</span>
    <span class="n">lasttol</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="n">lastx</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">gx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dLogLikelihood</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
        <span class="n">nh</span> <span class="o">=</span> <span class="n">d2LogLikelihood</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span><span class="n">gx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">dx</span><span class="p">)):</span>
            <span class="n">checktol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">checkrtol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="n">dx</span>  <span class="c1"># adding, not subtracting because of the handling of negatives</span>
            <span class="n">rx</span> <span class="o">=</span> <span class="n">dx</span><span class="o">/</span><span class="n">x</span>
            <span class="n">checktol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dx</span><span class="p">))</span>
            <span class="n">checkrtol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span><span class="n">rx</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">checkrtol</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">):</span>
            <span class="k">break</span>
            <span class="n">converge</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">checkrtol</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">checktol</span> <span class="o">&gt;</span> <span class="n">lasttol</span><span class="p">):</span>  <span class="c1"># we are possibly diverging. Switch to cg for a bit.</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fmin_cg</span><span class="p">(</span><span class="n">LogLikelihood</span><span class="p">,</span><span class="n">lastx</span><span class="p">,</span><span class="n">fprime</span><span class="o">=</span><span class="n">dLogLikelihood</span><span class="p">,</span><span class="n">gtol</span><span class="o">=</span><span class="n">itol</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="n">disp</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">quiet</span><span class="p">))</span>
            <span class="n">itol</span> <span class="o">*=</span> <span class="n">rtol</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">lastx</span>
            <span class="n">checktol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dx</span><span class="p">))</span>
        <span class="n">lasttol</span> <span class="o">=</span> <span class="n">checktol</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">maxiter</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">converge</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Too many iterations, convergence failing&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>    </div>

<div class="viewcode-block" id="MaxLikeUncertain"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.MaxLikeUncertain">[docs]</a><span class="k">def</span> <span class="nf">MaxLikeUncertain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">vave</span><span class="p">):</span>

    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># multiply back by N, since we were dealing with smaller numbers for numerical robustness.</span>
    <span class="n">fi</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">d2LogLikelihood</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

    <span class="n">d2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>

    <span class="c1"># We have a fit to the line y = m(x-Uave) + b, so to get the uncertainty in the free energy back, we need </span>
    <span class="c1"># to add M*Uave back to f.  The uncertainty in cov(b + m*Uave,b+m*Uave) = var(b) + Uave**2*var(m) + Uave*cov(v,m)</span>

    <span class="c1"># For two dimensioms, we have the line y = m1(x1-vave1) + m2(x2-vave2) + b</span>
    <span class="c1">#  Uncertainty will be cov(b + m1vave1 + m2vave2) = var(b) + vave1^2 var(m1) + vave2^2 var(m2)</span>
    <span class="c1">#                                                          + 2vave1 cov(m1,b) + 2vave2 cov(m2,b)</span>
    <span class="c1">#                                                          + 2vave1 cov(m1,m2)</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vave</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">vave</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">d2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>   <span class="c1"># should this last one be plus or minus</span>
        <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">vave</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vave</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">d2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="MaxLikeParams"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.MaxLikeParams">[docs]</a><span class="k">def</span> <span class="nf">MaxLikeParams</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">analytic_uncertainty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">g</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
    <span class="n">optimum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">vave</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">vmod</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">L</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">N_k</span><span class="p">)],</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="c1"># for numerical stability, we need to translate the curve</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
        <span class="n">vave</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N_k</span><span class="p">)</span>
        <span class="n">vmod</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">vave</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">vmod</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">vave</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">xstart</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
        <span class="n">xstart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vave</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">xstart</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">xstart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">df</span>
    <span class="n">xstart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">ofit</span> <span class="o">=</span> <span class="n">SolveMaxLike</span><span class="p">(</span><span class="n">xstart</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">vmod</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span><span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>

    <span class="n">optimum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
        <span class="n">optimum</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofit</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">optimum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">vave</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">ofit</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimum</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">analytic_uncertainty</span><span class="p">):</span>
        <span class="n">doptimum</span> <span class="o">=</span> <span class="n">MaxLikeUncertain</span><span class="p">(</span><span class="n">ofit</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">vmod</span><span class="p">,</span><span class="n">vave</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doptimum</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>

<span class="c1">#========================================================================================</span>
<span class="c1"># Functions for computing Bennett acceptance ratio</span>
<span class="c1">#==========================================================================================</span>
<div class="viewcode-block" id="logsum"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.logsum">[docs]</a><span class="k">def</span> <span class="nf">logsum</span><span class="p">(</span><span class="n">a_n</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Compute the log of a sum of exponentiated terms exp(a_n) in a numerically-stable manner:</span>

<span class="sd">    logsum a_n = max_arg + \log \sum_{n=1}^N \exp[a_n - max_arg]</span>

<span class="sd">  where max_arg = max_n a_n.  This is mathematically (but not numerically) equivalent to</span>

<span class="sd">    logsum a_n = \log \sum_{n=1}^N \exp[a_n]</span>

<span class="sd">  ARGUMENTS</span>
<span class="sd">    a_n (numpy array) - a_n[n] is the nth exponential argument</span>
<span class="sd">  </span>
<span class="sd">  RETURNS</span>
<span class="sd">    log_sum (float) - the log of the sum of exponentiated a_n, log (\sum_n exp(a_n))</span>

<span class="sd">  EXAMPLE  </span>
<span class="sd">    </span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># Compute the maximum argument.</span>
  <span class="n">max_log_term</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a_n</span><span class="p">)</span>

  <span class="c1"># Compute the reduced terms.</span>
  <span class="n">terms</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_n</span> <span class="o">-</span> <span class="n">max_log_term</span><span class="p">)</span>

  <span class="c1"># Compute the log sum.</span>
  <span class="n">log_sum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">terms</span><span class="p">))</span> <span class="o">+</span> <span class="n">max_log_term</span>
        
  <span class="k">return</span> <span class="n">log_sum</span></div>

<span class="c1">#=============================================================================================</span>
<span class="c1"># Bennett acceptance ratio function to be zeroed to solve for BAR.</span>
<span class="c1">#=============================================================================================</span>
<div class="viewcode-block" id="BARzero"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.BARzero">[docs]</a><span class="k">def</span> <span class="nf">BARzero</span><span class="p">(</span><span class="n">w_F</span><span class="p">,</span><span class="n">w_R</span><span class="p">,</span><span class="n">DeltaF</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ARGUMENTS</span>
<span class="sd">      w_F (numpy.array) - w_F[t] is the forward work value from snapshot t.</span>
<span class="sd">                        t = 0...(T_F-1)  Length T_F is deduced from vector.</span>
<span class="sd">      w_R (numpy.array) - w_R[t] is the reverse work value from snapshot t.</span>
<span class="sd">                        t = 0...(T_R-1)  Length T_R is deduced from vector.</span>

<span class="sd">      DeltaF (float) - Our current guess</span>

<span class="sd">    RETURNS</span>

<span class="sd">      fzero - a variable that is zeroed when DeltaF satisfies BAR.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Recommended stable implementation of BAR.</span>

    <span class="c1"># Determine number of forward and reverse work values provided.</span>
    <span class="n">T_F</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w_F</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="c1"># number of forward work values</span>
    <span class="n">T_R</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w_R</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="c1"># number of reverse work values</span>

    <span class="c1"># Compute log ratio of forward and reverse counts.</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_F</span> <span class="o">/</span> <span class="n">T_R</span><span class="p">)</span>
    
    <span class="c1"># Compute log numerator.</span>
    <span class="c1"># log f(W) = - log [1 + exp((M + W - DeltaF))]</span>
    <span class="c1">#          = - log ( exp[+maxarg] [exp[-maxarg] + exp[(M + W - DeltaF) - maxarg]] )</span>
    <span class="c1">#          = - maxarg - log[exp[-maxarg] + (T_F/T_R) exp[(M + W - DeltaF) - maxarg]]</span>
    <span class="c1"># where maxarg = max( (M + W - DeltaF) )</span>
    <span class="n">exp_arg_F</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="n">w_F</span> <span class="o">-</span> <span class="n">DeltaF</span><span class="p">)</span>
    <span class="n">max_arg_F</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">exp_arg_F</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">exp_arg_F</span><span class="p">))</span>
    <span class="n">log_f_F</span> <span class="o">=</span> <span class="o">-</span> <span class="n">max_arg_F</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">max_arg_F</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exp_arg_F</span> <span class="o">-</span> <span class="n">max_arg_F</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">log_numer</span> <span class="o">=</span> <span class="n">logsum</span><span class="p">(</span><span class="n">log_f_F</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_F</span><span class="p">)</span>
    
    <span class="c1"># Compute log_denominator.</span>
    <span class="c1"># log_denom = log &lt; f(-W) exp[-W] &gt;_R</span>
    <span class="c1"># NOTE: log [f(-W) exp(-W)] = log f(-W) - W</span>
    <span class="n">exp_arg_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">w_R</span> <span class="o">-</span> <span class="n">DeltaF</span><span class="p">)</span>
    <span class="n">max_arg_R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">exp_arg_R</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">exp_arg_R</span><span class="p">))</span>
    <span class="n">log_f_R</span> <span class="o">=</span> <span class="o">-</span> <span class="n">max_arg_R</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">max_arg_R</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exp_arg_R</span> <span class="o">-</span> <span class="n">max_arg_R</span><span class="p">)</span> <span class="p">)</span> <span class="o">-</span> <span class="n">w_R</span> 
    <span class="n">log_denom</span> <span class="o">=</span> <span class="n">logsum</span><span class="p">(</span><span class="n">log_f_R</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_R</span><span class="p">)</span>

    <span class="c1"># This function must be zeroed to find a root</span>
    <span class="n">fzero</span>  <span class="o">=</span> <span class="n">DeltaF</span> <span class="o">-</span> <span class="p">(</span><span class="n">log_denom</span> <span class="o">-</span> <span class="n">log_numer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fzero</span></div>

<div class="viewcode-block" id="BAR"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.BAR">[docs]</a><span class="k">def</span> <span class="nf">BAR</span><span class="p">(</span><span class="n">w_F</span><span class="p">,</span> <span class="n">w_R</span><span class="p">,</span> <span class="n">DeltaF</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">maximum_iterations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">relative_tolerance</span><span class="o">=</span><span class="mf">1.0e-10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Compute free energy difference using the Bennett acceptance ratio (BAR) method using false position</span>

<span class="sd">  ARGUMENTS</span>
<span class="sd">    w_F (numpy.array) - w_F[t] is the forward work value from snapshot t.</span>
<span class="sd">                        t = 0...(T_F-1)  Length T_F is deduced from vector.</span>
<span class="sd">    w_R (numpy.array) - w_R[t] is the reverse work value from snapshot t.</span>
<span class="sd">                        t = 0...(T_R-1)  Length T_R is deduced from vector.</span>

<span class="sd">  OPTIONAL ARGUMENTS</span>

<span class="sd">    DeltaF (float) - DeltaF can be set to initialize the free energy difference with a guess (default 0.0)</span>
<span class="sd">    maximum_iterations (int) - can be set to limit the maximum number of iterations performed (default 500)</span>
<span class="sd">    relative_tolerance (float) - can be set to determine the relative tolerance convergence criteria (defailt 1.0e-5)</span>
<span class="sd">    verbose (boolean) - should be set to True if verbse debug output is desired (default False)</span>

<span class="sd">  RETURNS</span>

<span class="sd">    [DeltaF, dDeltaF] where dDeltaF is the estimated std dev uncertainty</span>

<span class="sd">  REFERENCE</span>

<span class="sd">    [1] Shirts MR, Bair E, Hooker G, and Pande VS. Equilibrium free energies from nonequilibrium</span>
<span class="sd">    measurements using maximum-likelihood methods. PRL 91(14):140601, 2003.</span>

<span class="sd">  EXAMPLES</span>

<span class="sd">  Compute free energy difference between two specified samples of work values.</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">UpperB</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">w_F</span><span class="p">)</span>
  <span class="n">LowerB</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">w_R</span><span class="p">)</span>

  <span class="n">FUpperB</span> <span class="o">=</span> <span class="n">BARzero</span><span class="p">(</span><span class="n">w_F</span><span class="p">,</span><span class="n">w_R</span><span class="p">,</span><span class="n">UpperB</span><span class="p">)</span>
  <span class="n">FLowerB</span> <span class="o">=</span> <span class="n">BARzero</span><span class="p">(</span><span class="n">w_F</span><span class="p">,</span><span class="n">w_R</span><span class="p">,</span><span class="n">LowerB</span><span class="p">)</span>
  <span class="n">nfunc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    
  <span class="k">if</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FUpperB</span><span class="p">)</span> <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FLowerB</span><span class="p">)):</span>
      <span class="c1"># this data set is returning NAN -- will likely not work.  Return 0, print a warning:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: BAR is likely to be inaccurate because of poor sampling. Guessing 0.&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
      
  <span class="k">while</span> <span class="n">FUpperB</span><span class="o">*</span><span class="n">FLowerB</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="c1"># if they have the same sign, they do not bracket.  Widen the bracket until they have opposite signs.</span>
      <span class="c1"># There may be a better way to do this, and the above bracket should rarely fail.</span>
      <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial brackets did not actually bracket, widening them&#39;</span><span class="p">)</span>
      <span class="n">FAve</span> <span class="o">=</span> <span class="p">(</span><span class="n">UpperB</span><span class="o">+</span><span class="n">LowerB</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
      <span class="n">UpperB</span> <span class="o">=</span> <span class="n">UpperB</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">UpperB</span><span class="o">-</span><span class="n">FAve</span><span class="p">),</span><span class="mf">0.1</span><span class="p">)</span>
      <span class="n">LowerB</span> <span class="o">=</span> <span class="n">LowerB</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">LowerB</span><span class="o">-</span><span class="n">FAve</span><span class="p">),</span><span class="mf">0.1</span><span class="p">)</span>
      <span class="n">FUpperB</span> <span class="o">=</span> <span class="n">BARzero</span><span class="p">(</span><span class="n">w_F</span><span class="p">,</span><span class="n">w_R</span><span class="p">,</span><span class="n">UpperB</span><span class="p">)</span>
      <span class="n">FLowerB</span> <span class="o">=</span> <span class="n">BARzero</span><span class="p">(</span><span class="n">w_F</span><span class="p">,</span><span class="n">w_R</span><span class="p">,</span><span class="n">LowerB</span><span class="p">)</span>
      <span class="n">nfunc</span> <span class="o">+=</span> <span class="mi">2</span>

  <span class="c1"># Iterate to convergence or until maximum number of iterations has been exceeded.</span>

  <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maximum_iterations</span><span class="p">):</span>

      <span class="n">DeltaF_old</span> <span class="o">=</span> <span class="n">DeltaF</span>
    
      <span class="c1"># Predict the new value</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">LowerB</span><span class="o">==</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">UpperB</span><span class="o">==</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">DeltaF</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">FNew</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">DeltaF</span> <span class="o">=</span> <span class="n">UpperB</span> <span class="o">-</span> <span class="n">FUpperB</span><span class="o">*</span><span class="p">(</span><span class="n">UpperB</span><span class="o">-</span><span class="n">LowerB</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">FUpperB</span><span class="o">-</span><span class="n">FLowerB</span><span class="p">)</span>
        <span class="n">FNew</span> <span class="o">=</span> <span class="n">BARzero</span><span class="p">(</span><span class="n">w_F</span><span class="p">,</span><span class="n">w_R</span><span class="p">,</span><span class="n">DeltaF</span><span class="p">)</span>
      <span class="n">nfunc</span> <span class="o">+=</span> <span class="mi">1</span>
     
      <span class="k">if</span> <span class="n">FNew</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="c1"># Convergence is achieved.</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convergence achieved.&quot;</span><span class="p">)</span>
        <span class="n">relative_change</span> <span class="o">=</span> <span class="mi">10</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">break</span>

      <span class="c1"># Check for convergence.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">DeltaF</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
          <span class="c1"># The free energy difference appears to be zero -- return.</span>
          <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The free energy difference appears to be zero.&quot;</span><span class="p">)</span>
          <span class="k">return</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        
      <span class="n">relative_change</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">DeltaF</span> <span class="o">-</span> <span class="n">DeltaF_old</span><span class="p">)</span><span class="o">/</span><span class="n">DeltaF</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;relative_change = </span><span class="si">%12.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">relative_change</span><span class="p">)</span>
          
      <span class="k">if</span> <span class="p">((</span><span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">relative_change</span> <span class="o">&lt;</span> <span class="n">relative_tolerance</span><span class="p">)):</span>
          <span class="c1"># Convergence is achieved.</span>
          <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
              <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convergence achieved.&quot;</span><span class="p">)</span>
          <span class="k">break</span>

      <span class="k">if</span> <span class="n">FUpperB</span><span class="o">*</span><span class="n">FNew</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="c1"># these two now bracket the root</span>
          <span class="n">LowerB</span> <span class="o">=</span> <span class="n">DeltaF</span>
          <span class="n">FLowerB</span> <span class="o">=</span> <span class="n">FNew</span>
      <span class="k">elif</span> <span class="n">FLowerB</span><span class="o">*</span><span class="n">FNew</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
          <span class="c1"># these two now bracket the root</span>
          <span class="n">UpperB</span> <span class="o">=</span> <span class="n">DeltaF</span>
          <span class="n">FUpperB</span> <span class="o">=</span> <span class="n">FNew</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;WARNING: Cannot determine bound on free energy&#39;</span>
          <span class="k">raise</span> <span class="n">BoundsError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>        

      <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iteration </span><span class="si">%5d</span><span class="s2"> : DeltaF = </span><span class="si">%16.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">DeltaF</span><span class="p">))</span>

  <span class="c1"># Report convergence, or warn user if not achieved.</span>
  <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">maximum_iterations</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converged to tolerance of </span><span class="si">%e</span><span class="s1"> in </span><span class="si">%d</span><span class="s1"> iterations (</span><span class="si">%d</span><span class="s1"> function evaluations)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">relative_change</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span><span class="n">nfunc</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;WARNING: Did not converge to within specified tolerance. max_delta = </span><span class="si">%f</span><span class="s1">, TOLERANCE = </span><span class="si">%f</span><span class="s1">, MAX_ITS = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">relative_change</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">maximum_iterations</span><span class="p">)</span>
      <span class="k">raise</span> <span class="n">ConvergenceException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

  <span class="c1"># Compute asymptotic variance estimate using Eq. 10a of Bennett, 1976 (except with n_1&lt;f&gt;_1^2 in </span>
  <span class="c1"># the second denominator, it is an error in the original</span>
  <span class="c1"># NOTE: The numerical stability of this computation may need to be improved.</span>
      
  <span class="c1"># Determine number of forward and reverse work values provided.</span>

  <span class="n">T_F</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w_F</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="c1"># number of forward work values</span>
  <span class="n">T_R</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w_R</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="c1"># number of reverse work values</span>
  
  <span class="c1"># Compute log ratio of forward and reverse counts.</span>
  <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_F</span> <span class="o">/</span> <span class="n">T_R</span><span class="p">)</span>

  <span class="n">T_tot</span> <span class="o">=</span> <span class="n">T_F</span> <span class="o">+</span> <span class="n">T_R</span>

  <span class="n">C</span> <span class="o">=</span> <span class="n">M</span><span class="o">-</span><span class="n">DeltaF</span>
  
  <span class="n">fF</span> <span class="o">=</span>  <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">w_F</span> <span class="o">+</span> <span class="n">C</span><span class="p">))</span>
  <span class="n">fR</span> <span class="o">=</span>  <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">w_R</span> <span class="o">-</span> <span class="n">C</span><span class="p">))</span>
  
  <span class="n">afF2</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">fF</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
  <span class="n">afR2</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">fR</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
  
  <span class="n">vfF</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">fF</span><span class="p">)</span><span class="o">/</span><span class="n">T_F</span>
  <span class="n">vfR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">fR</span><span class="p">)</span><span class="o">/</span><span class="n">T_R</span>
  
  <span class="n">variance</span> <span class="o">=</span> <span class="n">vfF</span><span class="o">/</span><span class="n">afF2</span> <span class="o">+</span> <span class="n">vfR</span><span class="o">/</span><span class="n">afR2</span>
  
  <span class="n">dDeltaF</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeltaF = </span><span class="si">%8.3f</span><span class="s2"> +- </span><span class="si">%8.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DeltaF</span><span class="p">,</span> <span class="n">dDeltaF</span><span class="p">))</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">DeltaF</span><span class="p">,</span> <span class="n">dDeltaF</span><span class="p">)</span></div>

<div class="viewcode-block" id="Print1DStats"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.Print1DStats">[docs]</a><span class="k">def</span> <span class="nf">Print1DStats</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">fitvals</span><span class="p">,</span><span class="n">convert</span><span class="p">,</span><span class="n">trueslope</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">dfitvals</span><span class="o">=</span><span class="s1">&#39;N/A&#39;</span><span class="p">):</span>

    <span class="c1"># if dB, &#39;convert&#39; is kB</span>
    <span class="c1"># if dP, &#39;convert&#39; is beta*PV_convert</span>
    <span class="c1"># first element in fitvals is free energies df</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># second element in fitvals is the slope</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Need to fix this so that uncertainties aren&#39;t printed when ddf is &#39;N/A&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="c1"># true even if there is only one per slope</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">ddf</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ddf</span> <span class="o">=</span> <span class="n">dfitvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">slope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span> <span class="c1"># true even if there is only one</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>    
        <span class="n">dslope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dslope</span> <span class="o">=</span> <span class="n">dfitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     </span><span class="si">%20s</span><span class="s2">        &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     df = </span><span class="si">%.5f</span><span class="s2"> +/- </span><span class="si">%.5f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">ddf</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Estimated slope       vs.   True slope&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%11.6f</span><span class="s2"> +/- </span><span class="si">%11.6f</span><span class="s2">  |  </span><span class="si">%11.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">dslope</span><span class="p">,</span> <span class="n">trueslope</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>

    <span class="n">quant</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">slope</span><span class="o">-</span><span class="n">trueslope</span><span class="p">)</span><span class="o">/</span><span class="n">dslope</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(That&#39;s </span><span class="si">%.2f</span><span class="s2"> quantiles from true slope=</span><span class="si">%5f</span><span class="s2">, FYI.)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quant</span><span class="p">,</span><span class="n">trueslope</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">quant</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; (Ouch!)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dbeta&#39;</span><span class="p">):</span>    
        <span class="c1">#trueslope = B1 - B0, const = (B1 + B0)/2, B = 1/(k_B T)</span>
        <span class="c1"># so B0 = (const-trueslope/2), T0 = 1/(k_B*B0)</span>
        <span class="c1"># so B1 = (const+trueslope/2), T1 = 1/(k_B*B1)</span>
        <span class="n">T0</span> <span class="o">=</span> <span class="p">(</span><span class="n">convert</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">-</span><span class="n">trueslope</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">convert</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">+</span><span class="n">trueslope</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; True dT = </span><span class="si">%7.3f</span><span class="s2">, Eff. dT = </span><span class="si">%7.3f</span><span class="s2">+/-</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">T0</span><span class="o">-</span><span class="n">T1</span><span class="p">,</span> <span class="n">convert</span><span class="o">*</span><span class="n">T0</span><span class="o">*</span><span class="n">T1</span><span class="o">*</span><span class="n">slope</span><span class="p">,</span><span class="n">convert</span><span class="o">*</span><span class="n">dslope</span><span class="o">*</span><span class="n">T0</span><span class="o">*</span><span class="n">T1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dpressure-constB&#39;</span><span class="p">):</span>
        <span class="c1"># trueslope = B*PV_conv*(P1-P0), const = B*PV_conv*(P1+P0)/2, </span>
        <span class="c1"># we need to convert this slope to a pressure.  This should just be dividing by pvconvert*beta</span>
        <span class="c1">#</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; True dP = </span><span class="si">%7.3f</span><span class="s2">, Eff. dP = </span><span class="si">%7.3f</span><span class="s2">+/-</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">trueslope</span><span class="o">/</span><span class="n">convert</span><span class="p">,</span> <span class="o">-</span><span class="n">slope</span><span class="o">/</span><span class="n">convert</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dslope</span><span class="o">/</span><span class="n">convert</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dmu-constB&#39;</span><span class="p">):</span>
        <span class="c1"># trueslope = B*(mu1-mu0), const = B*(mu1+mu0)/2, </span>
        <span class="c1"># we need to convert this slope to a chemical potential.  This should just be dividing by beta</span>
        <span class="c1">#</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; True dmu = </span><span class="si">%7.3f</span><span class="s2">, Eff. dmu = </span><span class="si">%7.3f</span><span class="s2">+/-</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">trueslope</span><span class="o">/</span><span class="n">convert</span><span class="p">,</span> <span class="o">-</span><span class="n">slope</span><span class="o">/</span><span class="n">convert</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dslope</span><span class="o">/</span><span class="n">convert</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;ddmu-constB&#39;</span><span class="p">):</span>
        <span class="c1"># trueslope = B*(dmu1-dmu0), const = B*(dmu1+dmu0)/2, </span>
        <span class="c1"># we need to convert this slope to a chemical potential.  This should just be dividing by beta</span>
        <span class="c1">#</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; True ddmu = </span><span class="si">%7.3f</span><span class="s2">, Eff. ddmu = </span><span class="si">%7.3f</span><span class="s2">+/-</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">trueslope</span><span class="o">/</span><span class="n">convert</span><span class="p">,</span> <span class="o">-</span><span class="n">slope</span><span class="o">/</span><span class="n">convert</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dslope</span><span class="o">/</span><span class="n">convert</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Print2DStats"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.Print2DStats">[docs]</a><span class="k">def</span> <span class="nf">Print2DStats</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">fitvals</span><span class="p">,</span><span class="n">kB</span><span class="p">,</span><span class="n">convertback</span><span class="p">,</span><span class="n">trueslope</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">dfitvals</span><span class="o">=</span><span class="s1">&#39;N/A&#39;</span><span class="p">):</span>

    <span class="c1"># first element in fitvals is free energies df</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Need to fix this so that uncertainties aren&#39;t printed when ddf is &#39;N/A&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="c1"># true even if there is only one per slope</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">ddf</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ddf</span> <span class="o">=</span> <span class="n">dfitvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">slopes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># second element in fitvals is the energy slope</span>
    <span class="c1"># third element in fitvals is the PV slope </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">slopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitvals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">slope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">dslope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">slope</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">slopes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># true even if there is only one</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">slopes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>    
            <span class="n">dslope</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slopes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dslope</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfitvals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     </span><span class="si">%20s</span><span class="s2">        &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     df = </span><span class="si">%.5f</span><span class="s2"> +/- </span><span class="si">%.5f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">ddf</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Estimated slope[</span><span class="si">%d</span><span class="s2">]       vs.   True slope[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%11.6f</span><span class="s2"> +/- </span><span class="si">%11.6f</span><span class="s2">  |  </span><span class="si">%11.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dslope</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">trueslope</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        
        <span class="n">quant</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">slope</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">trueslope</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">dslope</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(That&#39;s </span><span class="si">%.2f</span><span class="s2"> quantiles from true slope=</span><span class="si">%5f</span><span class="s2">, FYI.)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quant</span><span class="p">,</span><span class="n">trueslope</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">quant</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; (Ouch!)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1">#dp = B1 - B0, const = (B1 + B0)/2, B = 1/kbT</span>
    <span class="c1"># so B0 = (const[0]-trueslope[0]/2), T0 = 1/(kB*B0)</span>
    <span class="c1"># so B1 = (const[0]+trueslope[0]/2), T1 = 1/(kB*B1)</span>
    <span class="n">T0</span> <span class="o">=</span> <span class="p">(</span><span class="n">kB</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">trueslope</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">kB</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">trueslope</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; True dT = </span><span class="si">%7.3f</span><span class="s2">, Eff. dT = </span><span class="si">%7.3f</span><span class="s2">+/-</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">T0</span><span class="o">-</span><span class="n">T1</span><span class="p">,</span> <span class="n">kB</span><span class="o">*</span><span class="n">T0</span><span class="o">*</span><span class="n">T1</span><span class="o">*</span><span class="n">slope</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">kB</span><span class="o">*</span><span class="n">dslope</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">T0</span><span class="o">*</span><span class="n">T1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dpressure&#39;</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;dP&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dmu&#39;</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;dmu&#39;</span> 
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-ddmu&#39;</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;ddmu&#39;</span> 
        
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; True </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%7.3f</span><span class="s2">, Eff. </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%7.3f</span><span class="s2">+/-</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="o">-</span><span class="n">trueslope</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">convertback</span><span class="p">,</span><span class="n">text</span><span class="p">,</span> <span class="o">-</span><span class="n">slope</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">convertback</span><span class="p">,</span> <span class="n">dslope</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">convertback</span><span class="p">))</span></div>


<div class="viewcode-block" id="PrintPicture"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.PrintPicture">[docs]</a><span class="k">def</span> <span class="nf">PrintPicture</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">figname</span><span class="p">,</span><span class="n">fittype</span><span class="p">,</span><span class="n">vunits</span><span class="o">=</span><span class="s1">&#39;kT&#39;</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*************&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Note: Figures not generated because matplotlib not found. &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please install matplotlib to allow generation of pictures&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span> <span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span>
            <span class="s1">&#39;weight&#39;</span> <span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span>   <span class="p">:</span> <span class="s1">&#39;14&#39;</span><span class="p">}</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">font</span><span class="p">)</span>

    <span class="p">[</span><span class="n">vt</span><span class="p">,</span><span class="n">pstring</span><span class="p">,</span><span class="n">plinfit</span><span class="p">,</span><span class="n">pnlfit</span><span class="p">,</span><span class="n">varstring</span><span class="p">,</span><span class="n">legend_location</span><span class="p">]</span> <span class="o">=</span> <span class="n">PrepStrings</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span><span class="n">vunits</span><span class="o">=</span><span class="n">vunits</span><span class="p">)</span>

    <span class="n">pstringtex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\frac{P_2(&#39;</span> <span class="o">+</span> <span class="n">vt</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)}{P_1(&#39;</span> <span class="o">+</span> <span class="n">vt</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)}$&#39;</span> 
    <span class="n">pstringlntex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\ln\frac{P_2(&#39;</span> <span class="o">+</span> <span class="n">vt</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)}{P_1(&#39;</span> <span class="o">+</span> <span class="n">vt</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)}$&#39;</span> 

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now printing figure </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">figname</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">varstring</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fittype</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">vt</span> <span class="o">+</span> <span class="s1">&#39; vs. log probability ratio </span><span class="se">\n</span><span class="s1"> for &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="n">pstringlntex</span><span class="p">)</span>  <span class="c1"># make this general!</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;k-&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="n">plinfit</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Fit to $y = b+aB$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">pstringlntex</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">fittype</span> <span class="o">==</span> <span class="s1">&#39;nonlinear&#39;</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">vt</span> <span class="o">+</span> <span class="s1">&#39; vs. probability ratio </span><span class="se">\n</span><span class="s1"> for &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="n">pstringtex</span><span class="p">)</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;k-&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="n">pnlfit</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Fit to $y = \exp(b+aE)$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">pstringtex</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">fittype</span> <span class="o">==</span> <span class="s1">&#39;maxwell&#39;</span><span class="p">):</span>
        <span class="c1"># only valid for kinetic energy</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;E_kin vs. probability </span><span class="se">\n</span><span class="s1"> for&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$P(E_{\mathrm</span><span class="si">{kin}</span><span class="s1">})$&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">true</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>  <span class="c1"># sometimes, true will be none.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;k-&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Fit to Analytical&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Fit to Normal&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$P(E_{\mathrm</span><span class="si">{kin}</span><span class="s1">})$&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m crying foul!  </span><span class="si">%s</span><span class="s2"> is not an allowed chart type!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fittype</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">legend_location</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenHistogramProbs"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.GenHistogramProbs">[docs]</a><span class="k">def</span> <span class="nf">GenHistogramProbs</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span><span class="n">bins</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">g</span><span class="p">):</span>

    <span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">N_k</span><span class="p">)</span>
    
    <span class="n">hlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dhlist</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># check for zero bins</span>
    <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">right</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K</span><span class="p">):</span>
        <span class="n">hstat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hstat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">center</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">:</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="n">e</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K</span><span class="p">):</span>
        <span class="n">hstat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">hstat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
        <span class="n">hlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">dhlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dh</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hlist</span><span class="p">,</span><span class="n">dhlist</span><span class="p">,</span><span class="n">bins</span></div>

<div class="viewcode-block" id="LinFit"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.LinFit">[docs]</a><span class="k">def</span> <span class="nf">LinFit</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">N_k</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
           <span class="n">analytic_uncertainty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
           <span class="n">screen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eunits</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="p">[</span><span class="n">hlist</span><span class="p">,</span><span class="n">dhlist</span><span class="p">,</span><span class="n">bins</span><span class="p">]</span> <span class="o">=</span> <span class="n">GenHistogramProbs</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span><span class="n">bins</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">g</span><span class="p">)</span>

    <span class="n">ratio</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">hlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># this should have the proper exponential distribution </span>
    <span class="n">dratio</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dhlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">hlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dhlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">hlist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">usedat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="n">usedat</span><span class="p">]</span>
    <span class="n">nuse</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">dratio</span><span class="p">[</span><span class="n">usedat</span><span class="p">]</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)])</span><span class="o">/</span><span class="mi">2</span>    
    <span class="n">x</span> <span class="o">=</span> <span class="n">xaxis</span><span class="p">[</span><span class="n">usedat</span><span class="p">]</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">nuse</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> 
    <span class="n">WX</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">X</span><span class="p">)</span>
    <span class="n">WY</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">WXT</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">WX</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">WXT</span><span class="p">,</span><span class="n">WX</span><span class="p">)</span>
    <span class="n">WXY</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">WXT</span><span class="p">,</span><span class="n">WY</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">WXY</span><span class="p">)</span>
    <span class="n">da_matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Z</span><span class="p">))</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">da</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">da_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">da</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">da_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># the true line is y = df + dp*x, where y is ln P_1(X)/P_2(X)</span>

    <span class="n">do_plot</span> <span class="o">=</span> <span class="n">screen</span> <span class="ow">or</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">do_plot</span><span class="p">:</span>
        <span class="n">trueslope</span> <span class="o">=</span> <span class="n">dp</span>
        <span class="n">true</span> <span class="o">=</span> <span class="n">df</span><span class="o">+</span><span class="n">trueslope</span><span class="o">*</span><span class="n">xaxis</span> 
        <span class="n">fit</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">xaxis</span>

        <span class="c1">#PrintData(xaxis,true,fit,ratio,dratio,&#39;linear&#39;)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; (linear)&#39;</span>
        <span class="c1">#PrintPicture(xaxis,true,ratio,dratio,fit,type,name,figname,&#39;linear&#39;,vunits)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">,</span>
                 <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">ratio</span><span class="p">,</span>
                 <span class="s1">&#39;y_err&#39;</span><span class="p">:</span> <span class="n">dratio</span><span class="p">,</span>
                 <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Simulation&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">,</span>
                 <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">fit</span><span class="p">,</span>
                 <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit to simulation&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">,</span>
                 <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                 <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Analytical ratio&#39;</span><span class="p">}]</span>

        <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">eunits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">eunits</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>

        <span class="n">annot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">analytic_uncertainty</span><span class="p">:</span>
            <span class="n">annot</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">da</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span>
                     <span class="s1">&#39; quantiles&#39;</span><span class="p">)</span>

        <span class="n">plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                  <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span>
                  <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Log probability ratio&#39;</span><span class="p">,</span>
                  <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Energy&#39;</span> <span class="o">+</span> <span class="n">units</span><span class="p">,</span>
                  <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\log\frac{P_2(E)}{P_1(E)}$&#39;</span><span class="p">,</span>
                  <span class="n">sci_x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                  <span class="n">screen</span><span class="o">=</span><span class="n">screen</span><span class="p">,</span>
                  <span class="n">axtext</span><span class="o">=</span><span class="n">annot</span><span class="p">)</span>



    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">analytic_uncertainty</span><span class="p">):</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="SolveNonLin"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.SolveNonLin">[docs]</a><span class="k">def</span> <span class="nf">SolveNonLin</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">ddata</span><span class="p">,</span><span class="n">xaxis</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">usedat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">usedat</span><span class="p">]</span>
    <span class="n">nuse</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">ddata</span><span class="p">[</span><span class="n">usedat</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> 
    <span class="n">x</span> <span class="o">=</span> <span class="n">xaxis</span><span class="p">[</span><span class="n">usedat</span><span class="p">]</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nuse</span><span class="p">,</span><span class="n">K</span><span class="p">],</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># do the newton-raphson solution</span>
    <span class="n">endnext</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        
        <span class="n">expt</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        
        <span class="n">J</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">df</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
        <span class="n">WJ</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">J</span><span class="p">)</span>
        <span class="n">JTW</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">WJ</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">expt</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">JTW</span><span class="p">,</span><span class="n">WJ</span><span class="p">)</span>
        <span class="n">incr_a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">JTW</span><span class="p">,</span><span class="n">dy</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">+=</span> <span class="n">incr_a</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">incr_a</span><span class="o">/</span><span class="n">a</span>
        <span class="n">chtol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">ra</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chtol</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">endnext</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">analytical_estimate</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">endnow</span> <span class="o">==</span> <span class="kc">True</span>   <span class="c1"># we put in this logic so that we calculate the matrix at the minimum</span>
                                     <span class="c1"># if we want the analytic uncertainty </span>
            <span class="n">endnext</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">endnow</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">maxiter</span><span class="p">):</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Too many iterations for nonlinear least squares&quot;</span><span class="p">)</span>

    <span class="n">da_matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
        <span class="n">da</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">da_matrix</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">a</span><span class="p">,</span><span class="n">da</span>    </div>

<div class="viewcode-block" id="ExpFit"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.ExpFit">[docs]</a><span class="k">def</span> <span class="nf">ExpFit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># assume only 2D, since we are not generating histograms</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="dExpFit"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.dExpFit">[docs]</a><span class="k">def</span> <span class="nf">dExpFit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e</span><span class="p">,</span><span class="n">x</span><span class="o">*</span><span class="n">e</span><span class="p">])</span></div>

<div class="viewcode-block" id="NonLinFit"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.NonLinFit">[docs]</a><span class="k">def</span> <span class="nf">NonLinFit</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">analytic_uncertainty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bGraph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
              <span class="n">figname</span><span class="o">=</span><span class="s1">&#39;nonlin_figure&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span><span class="n">g</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;dbeta-constV&#39;</span><span class="p">,</span><span class="n">vunits</span><span class="o">=</span><span class="s1">&#39;kT&#39;</span><span class="p">):</span>

    <span class="c1"># nonlinear model is exp(A + B*E_i), where the i are the bin energies.</span>
    <span class="c1"># residuals are y_i - exp(A + B*E_i)</span>
    <span class="c1"># dS/dbeta_j = 2\sum_i r_i dr_i/dB_j = 0 </span>
    <span class="c1"># </span>
    <span class="c1"># dr_i/dA = exp(A + B*E_i)</span>
    <span class="c1"># dr_i/dB = E_i*exp(A + B*E_i)</span>

    <span class="p">[</span><span class="n">hlist</span><span class="p">,</span><span class="n">dhlist</span><span class="p">,</span><span class="n">bins</span><span class="p">]</span> <span class="o">=</span> <span class="n">GenHistogramProbs</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span><span class="n">bins</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">g</span><span class="p">)</span>

    <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">hlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">hlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># this should have the proper exponential distribution </span>
    <span class="n">dratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dhlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">hlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dhlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">hlist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)])</span><span class="o">/</span><span class="mi">2</span>    

    <span class="c1"># starting point for nonlinear fit</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">L</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[:]</span>

    <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">da</span><span class="p">)</span> <span class="o">=</span> <span class="n">SolveNonLin</span><span class="p">(</span><span class="n">ExpFit</span><span class="p">,</span><span class="n">dExpFit</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ratio</span><span class="p">,</span><span class="n">dratio</span><span class="p">,</span><span class="n">xaxis</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bGraph</span><span class="p">):</span>
        <span class="n">trueslope</span> <span class="o">=</span> <span class="n">dp</span>
        <span class="n">true</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">df</span><span class="o">+</span><span class="n">trueslope</span><span class="o">*</span><span class="n">xaxis</span><span class="p">)</span> 
        <span class="n">fit</span> <span class="o">=</span> <span class="n">ExpFit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">xaxis</span><span class="p">)</span>
        
        <span class="n">PrintData</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="n">ratio</span><span class="p">,</span><span class="n">dratio</span><span class="p">,</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; (nonlinear)&#39;</span>
        <span class="n">PrintPicture</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">ratio</span><span class="p">,</span><span class="n">dratio</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">figname</span><span class="p">,</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">,</span><span class="n">vunits</span><span class="o">=</span><span class="n">vunits</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">analytic_uncertainty</span><span class="p">):</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="MaxwellBoltzFit"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.MaxwellBoltzFit">[docs]</a><span class="k">def</span> <span class="nf">MaxwellBoltzFit</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">kT</span><span class="p">,</span><span class="n">figname</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">ndof</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">g</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="c1"># generate histogram</span>
    <span class="n">hstat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="p">)</span>
    <span class="c1"># normalize the histogram</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">hstat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">N</span> 
    <span class="c1"># compute the error bars</span>
    <span class="n">dh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)])</span><span class="o">/</span><span class="mi">2</span>    

    <span class="c1"># we assume we have the correct mean for now, since presumably the temperature works</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> 
    <span class="n">std_fit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="n">std_true</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span><span class="o">*</span><span class="n">kT</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mean</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="o">*</span><span class="n">kT</span><span class="p">):</span>  <span class="c1">#if too big, we use a normal distribution -- we&#39;ll use limit of 50 DOF as suggest (by Wikipedia!)</span>
        <span class="c1"># note that for a normal distribution, the sample mean and standard deviation give the maximum likelihood information.</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xaxis</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">std_fit</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">std_fit</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">true</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xaxis</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">std_true</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">std_true</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># check this with paper?</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># should be a gamma distribution; no std fit</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="p">(</span><span class="n">xaxis</span><span class="o">/</span><span class="n">kT</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">mean</span><span class="o">/</span><span class="n">kT</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xaxis</span><span class="o">/</span><span class="n">kT</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">kT</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">mean</span><span class="o">/</span><span class="n">kT</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ndof</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">mean_true</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">ndof</span><span class="o">*</span><span class="n">kT</span>
            <span class="n">true</span> <span class="o">=</span> <span class="p">(</span><span class="n">xaxis</span><span class="o">/</span><span class="n">kT</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">mean_true</span><span class="o">/</span><span class="n">kT</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xaxis</span><span class="o">/</span><span class="n">kT</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">kT</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">mean</span><span class="o">/</span><span class="n">kT</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">true</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># unless we know the number of DOF, we don&#39;t know the true distribution:</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Kinetic energy analysis ---&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kT = </span><span class="si">%10.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kT</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ndof</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Effective # of DOF = </span><span class="si">%10.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">mean</span><span class="o">/</span><span class="n">kT</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>     
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reported # of DOF = </span><span class="si">%10.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ndof</span><span class="p">)</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">mean</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="o">*</span><span class="n">kT</span><span class="p">):</span>
        <span class="s2">&quot;Approximating the Maxwell-Boltzmann with a normal distribution, as # DOF &gt; 50&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Direct Std = </span><span class="si">%10.4f</span><span class="s2">, Std from sqrt(U*kT) = </span><span class="si">%10.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">std_fit</span><span class="p">,</span><span class="n">std_true</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># name = name + str</span>
    <span class="c1"># normalize histogram and error bars</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># assumes equal spacing (currently true)</span>
    <span class="n">h</span> <span class="o">/=</span> <span class="n">width</span>
    <span class="n">dh</span> <span class="o">/=</span> <span class="n">width</span>
    <span class="n">PrintPicture</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">dh</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="s1">&#39;dbeta-constV&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">figname</span><span class="p">,</span><span class="s1">&#39;maxwell&#39;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PrintData"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.PrintData">[docs]</a><span class="k">def</span> <span class="nf">PrintData</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="n">collected</span><span class="p">,</span><span class="n">dcollected</span><span class="p">,</span><span class="nb">type</span><span class="p">):</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----  Linear Fit  ----&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;nonlinear&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----  Nonlinear Fit  ----&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;maxwell&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----  fit to Maxwell-Boltzmann ----&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">quit</span><span class="p">(</span><span class="s2">&quot;Sorry, no allowed type of fit (</span><span class="si">%s</span><span class="s2">) specified!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      X         True     Observed     Error   d(true/obs) sig(true/obs)  Fit   &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------------------------------------------&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">collected</span><span class="p">)):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">collected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">dcollected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10.3f</span><span class="s2"> </span><span class="si">%10.3f</span><span class="s2"> </span><span class="si">%10.3f</span><span class="s2"> </span><span class="si">%10.3f</span><span class="s2"> </span><span class="si">%10.3f</span><span class="s2"> </span><span class="si">%10.3f</span><span class="s2"> </span><span class="si">%10.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xaxis</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">collected</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dcollected</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">diff</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">fit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span></div>


<div class="viewcode-block" id="ProbabilityAnalysis"><a class="viewcode-back" href="../../../physical_validation.util.html#physical_validation.util.checkensemble.ProbabilityAnalysis">[docs]</a><span class="k">def</span> <span class="nf">ProbabilityAnalysis</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;dbeta-constV&#39;</span><span class="p">,</span>
                        <span class="n">T_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">P_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mu_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">U_kn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">V_kn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N_kn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">kB</span><span class="o">=</span><span class="mf">0.0083144624</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                        <span class="n">bMaxLikelihood</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bLinearFit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bNonLinearFit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reptype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nboots</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                        <span class="n">g</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">reps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cuttails</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bMaxwell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">screen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">N_k</span><span class="p">)</span>  <span class="c1"># should be 2 pretty much always . . . </span>

    <span class="c1"># decide if we are printing figures:</span>
    <span class="n">do_plot</span> <span class="o">=</span> <span class="n">screen</span> <span class="ow">or</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="c1"># get correct conversion terms between different units.</span>
    <span class="n">conversions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conversions</span> <span class="o">=</span> <span class="n">prepare_conversion_factors</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">seed</span><span class="p">):</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>  <span class="c1"># so there is the ability to make the RNG repeatable</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;setting random number seed for bootstrapping </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">seed</span><span class="p">))</span>
    <span class="c1"># initialize constant terms</span>
    <span class="n">beta_ave</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">P_ave</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mu_ave</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">T_k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">T_k</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">beta_k</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">kB</span><span class="o">*</span><span class="n">T_k</span><span class="p">))</span>
        <span class="n">beta_ave</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">beta_k</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">P_k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>    
        <span class="n">P_k</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P_ave</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">P_k</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mu_k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>    
        <span class="n">mu_k</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mu_ave</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">mu_k</span><span class="p">)</span>
 
   <span class="c1"># prepare the variables we are going to work with    </span>
    <span class="p">[</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">vr</span><span class="p">]</span> <span class="o">=</span> <span class="n">PrepInputs</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span><span class="n">conversions</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">beta_k</span><span class="p">,</span><span class="n">beta_ave</span><span class="p">,</span><span class="n">P_k</span><span class="p">,</span><span class="n">P_ave</span><span class="p">,</span><span class="n">mu_k</span><span class="p">,</span><span class="n">mu_ave</span><span class="p">,</span><span class="n">U_kn</span><span class="p">,</span><span class="n">V_kn</span><span class="p">,</span><span class="n">N_kn</span><span class="p">)</span>
    <span class="p">[</span><span class="n">vt</span><span class="p">,</span><span class="n">pstring</span><span class="p">,</span><span class="n">plinfit</span><span class="p">,</span><span class="n">pnlfit</span><span class="p">,</span><span class="n">varstring</span><span class="p">,</span><span class="n">legend_location</span><span class="p">]</span> <span class="o">=</span> <span class="n">PrepStrings</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">)):</span>  <span class="c1"># if it&#39;s 2D, we can graph, otherwise, there is too much histogram error </span>

        <span class="c1"># determine the bin widths</span>
        <span class="n">maxk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">mink</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># cuttails indicates how many we leave out on each tail</span>
        <span class="c1"># for now, we choose the range that cuts 0.1% from the tails of the smallest distribution.</span>
        <span class="n">prange</span> <span class="o">=</span> <span class="n">cuttails</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="n">maxk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">prange</span><span class="p">))</span>
            <span class="n">mink</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">prange</span><span class="p">))</span>

        <span class="n">binmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">maxk</span><span class="p">)</span>
        <span class="n">binmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mink</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">binmax</span> <span class="o">&lt;</span> <span class="n">binmin</span><span class="p">):</span>
            <span class="n">quit</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">There is no overlap between the two ensembles; high distribution min is </span><span class="si">%f</span><span class="s2"> and low distribution max is </span><span class="si">%f</span><span class="s2">; quitting!&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">binmin</span><span class="p">,</span><span class="n">binmax</span><span class="p">));</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dmu-constB&#39;</span><span class="p">):</span>   <span class="c1"># special code for N, since it&#39;s discrete</span>
                                     <span class="c1"># if the spread is greater than</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">binmax</span><span class="o">-</span><span class="n">binmin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nbins</span><span class="p">):</span> 
                <span class="n">bins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">binmin</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">binmax</span><span class="o">+</span><span class="mf">0.6</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">nbins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: since the range of particle number is greater than the &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of bins specified, particle number is not discrete for &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;methods using histograms.  Set nbins larger (using --nbins) to &quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;obtain discrete N distributions&quot;</span><span class="p">)</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">binmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">binmax</span><span class="o">-</span><span class="n">binmin</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">nbins</span><span class="p">))</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">binmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">binmax</span><span class="o">-</span><span class="n">binmin</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">nbins</span><span class="p">))</span>    

    <span class="c1">#===================================================================================================</span>
    <span class="c1"># Calculate free energies with different methods</span>
    <span class="c1">#===================================================================================================    </span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dpressure&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dmu&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">quit</span><span class="p">(</span><span class="s2">&quot;Warning: two input temperatures are equal, can&#39;t do joint variable fit!&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dpressure&#39;</span><span class="p">):</span>
                <span class="n">quit</span><span class="p">(</span><span class="s2">&quot;Warning: two input pressures are equal, can&#39;t do joint E,V fit!&quot;</span><span class="p">);</span>            
            <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dmu&#39;</span><span class="p">):</span>
                <span class="n">quit</span><span class="p">(</span><span class="s2">&quot;Warning: two input chemical potentials are equal, can&#39;t do joint E,N fit!&quot;</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trueslope</span> <span class="o">=</span> <span class="n">dp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;True slope of </span><span class="si">%s</span><span class="s2"> should be </span><span class="si">%.8f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pstring</span><span class="p">,</span><span class="n">trueslope</span><span class="p">))</span>
  
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dpressure-constB&#39;</span> <span class="ow">or</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dpressure&#39;</span><span class="p">:</span>
        <span class="n">convertback</span> <span class="o">=</span> <span class="n">beta_ave</span><span class="o">*</span><span class="n">conversions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># this is the pv component</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dmu-constB&#39;</span> <span class="ow">or</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dmu&#39;</span><span class="p">:</span>
        <span class="n">convertback</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">kB</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">convertback</span> <span class="o">=</span> <span class="n">kB</span>
        
    <span class="n">w_F</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">U_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">w_R</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">U_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-constP&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dpressure-constB&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dpressure&#39;</span><span class="p">):</span>
        <span class="n">w_F</span> <span class="o">+=</span> <span class="n">conversions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P_k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">V_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>       
        <span class="n">w_R</span> <span class="o">+=</span> <span class="o">-</span><span class="n">conversions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P_k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">V_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>       

    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-constmu&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dmu-constB&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;dbeta-dmu&#39;</span><span class="p">):</span>  
        <span class="n">w_F</span> <span class="o">+=</span> <span class="o">-</span><span class="p">(</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">mu_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mu_k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">N_kn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>       
        <span class="n">w_R</span> <span class="o">+=</span> <span class="p">(</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">mu_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">beta_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mu_k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">N_kn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>       
        <span class="c1"># it&#39;s not entirely clear if this right because of lack of overlap in phase space between different N&#39;s! </span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now computing log of partition functions using BAR&quot;</span><span class="p">)</span>
    
    <span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">ddf</span><span class="p">)</span> <span class="o">=</span> <span class="n">BAR</span><span class="p">(</span><span class="n">w_F</span><span class="p">,</span><span class="n">w_R</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;using </span><span class="si">%.5f</span><span class="s2"> for log of partition functions computed from BAR&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Uncertainty in quantity is </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ddf</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assuming this is negligible compared to sampling error at individual points&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bMaxwell</span><span class="p">):</span>  <span class="c1"># only applies for kinetic energies</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now fitting to a Maxwell-Boltzmann distribution&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;_maxboltz&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">MaxwellBoltzFit</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="n">U_kn</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">kB</span><span class="o">*</span><span class="n">T_k</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">fn</span><span class="p">)</span>

    <span class="n">quant</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bLinearFit</span> <span class="ow">and</span> <span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now computing the linear fit parameters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;_linear&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="p">(</span><span class="n">fitvals</span><span class="p">,</span><span class="n">dfitvals</span><span class="p">)</span> <span class="o">=</span> <span class="n">LinFit</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">N_k</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                                    <span class="n">analytic_uncertainty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">,</span>
                                    <span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">screen</span><span class="o">=</span><span class="n">screen</span><span class="p">)</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dslope</span> <span class="o">=</span> <span class="n">dfitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">((</span><span class="n">slope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">dslope</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">Print1DStats</span><span class="p">(</span><span class="s1">&#39;Linear Fit Analysis (analytical error)&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">fitvals</span><span class="p">,</span><span class="n">convertback</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">dfitvals</span><span class="o">=</span><span class="n">dfitvals</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bNonLinearFit</span> <span class="ow">and</span> <span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now computing the nonlinear fit parameters&quot;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;_nonlinear&#39;</span>
        <span class="p">(</span><span class="n">fitvals</span><span class="p">,</span><span class="n">dfitvals</span><span class="p">)</span> <span class="o">=</span> <span class="n">NonLinFit</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">figname</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span><span class="n">bGraph</span><span class="o">=</span><span class="n">do_plot</span><span class="p">,</span><span class="n">analytic_uncertainty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span><span class="n">vunits</span><span class="o">=</span><span class="n">vunits</span><span class="p">)</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dslope</span> <span class="o">=</span> <span class="n">dfitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">((</span><span class="n">slope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">dslope</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">Print1DStats</span><span class="p">(</span><span class="s1">&#39;Nonlinear Fit Analysis (analytical error)&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">fitvals</span><span class="p">,</span><span class="n">convertback</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">dfitvals</span><span class="o">=</span><span class="n">dfitvals</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bMaxLikelihood</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now computing the maximum likelihood parameters&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">fitvals</span><span class="p">,</span><span class="n">dfitvals</span><span class="p">)</span> <span class="o">=</span> <span class="n">MaxLikeParams</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">analytic_uncertainty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">g</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">g</span><span class="p">),</span><span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="n">Print1DStats</span><span class="p">(</span><span class="s1">&#39;Maximum Likelihood Analysis (analytical error)&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">fitvals</span><span class="p">,</span><span class="n">convertback</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">dfitvals</span><span class="o">=</span><span class="n">dfitvals</span><span class="p">)</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dslope</span> <span class="o">=</span> <span class="n">dfitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;maxLikelihood&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">((</span><span class="n">slope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">dslope</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="n">Print2DStats</span><span class="p">(</span><span class="s1">&#39;2D-Maximum Likelihood Analysis (analytical error)&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">fitvals</span><span class="p">,</span><span class="n">kB</span><span class="p">,</span><span class="n">convertback</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">dfitvals</span><span class="o">=</span><span class="n">dfitvals</span><span class="p">)</span>
            <span class="n">eneslope</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pvslope</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">deneslope</span> <span class="o">=</span> <span class="n">dfitvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dpvslope</span> <span class="o">=</span> <span class="n">dfitvals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;maxLikelihood&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">((</span><span class="n">eneslope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">deneslope</span><span class="p">),</span>
                                      <span class="nb">abs</span><span class="p">((</span><span class="n">pvslope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">dpvslope</span><span class="p">)]</span>

    <span class="n">returnvalue</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">bMaxLikelihood</span><span class="p">:</span>
        <span class="n">returnvalue</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;maxLikelihood&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">bLinearFit</span><span class="p">:</span>
        <span class="n">returnvalue</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">bNonLinearFit</span><span class="p">:</span>
        <span class="n">returnvalue</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">reptype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">returnvalue</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">reptype</span> <span class="o">==</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">):</span>
        <span class="n">nreps</span> <span class="o">=</span> <span class="n">nboots</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nreps</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nreps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning, less than 50 bootstraps (</span><span class="si">%d</span><span class="s2"> requested) is likely not a good statistical idea&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nreps</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot provide bootstrap statisics, only </span><span class="si">%d</span><span class="s2"> requested&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nreps</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">returnvalue</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now bootstrapping (n=</span><span class="si">%d</span><span class="s2">) for uncertainties . . . could take a bit of time!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nreps</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">reptype</span> <span class="o">==</span> <span class="s1">&#39;independent&#39;</span><span class="p">):</span>
        <span class="n">nreps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reps</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now analyzing </span><span class="si">%d</span><span class="s2"> independent samples . . . could take a bit of time!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nreps</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">quit</span><span class="p">(</span><span class="s2">&quot;Don&#39;t understand reptype = </span><span class="si">%s</span><span class="s2">; quitting&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reptype</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>   <span class="c1"># how many values do we have to deal with?</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">linvals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">rval</span><span class="p">,</span><span class="n">nreps</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">nlvals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">rval</span><span class="p">,</span><span class="n">nreps</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">mlvals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">rval</span><span class="p">,</span><span class="n">nreps</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nreps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished </span><span class="si">%d</span><span class="s2"> samples . . .&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">reptype</span> <span class="o">==</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">):</span>    
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)):</span>
                    <span class="c1">#do normal bootstrap</span>
                    <span class="n">rindex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>  <span class="c1"># bootstrap it </span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">const</span><span class="p">)):</span>
                        <span class="n">vr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">rindex</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we are given correlation times.  Do block bootstrapping.</span>
                    <span class="n">gk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                    <span class="n">nblocks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">gk</span><span class="p">))</span>
                    <span class="c1"># moving blocks bootstrap; all contiguous segments of length gk</span>

                    <span class="n">rindex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="n">gk</span><span class="o">*</span><span class="p">(</span><span class="n">nblocks</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="n">nblocks</span><span class="p">);</span> 
                    <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">const</span><span class="p">)):</span>
                            <span class="n">vr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">nb</span><span class="o">*</span><span class="n">gk</span><span class="p">:(</span><span class="n">nb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gk</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">rindex</span><span class="p">[</span><span class="n">nb</span><span class="p">]:</span><span class="n">rindex</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="o">+</span><span class="n">gk</span><span class="p">]</span>
                    <span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nblocks</span><span class="o">*</span><span class="n">gk</span>  <span class="c1"># we could have a few samples less now</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="n">reptype</span> <span class="o">==</span> <span class="s1">&#39;independent&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">const</span><span class="p">)):</span>
                    <span class="n">vr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">reps</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">N_k</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> 
            
        <span class="k">if</span> <span class="p">(</span><span class="n">bLinearFit</span> <span class="ow">and</span> <span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">)):</span>    
            <span class="n">fitvals</span> <span class="o">=</span> <span class="n">LinFit</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">vr</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rval</span><span class="p">):</span>
                <span class="n">linvals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">bNonLinearFit</span> <span class="ow">and</span> <span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">)):</span>
            <span class="n">fitvals</span> <span class="o">=</span> <span class="n">NonLinFit</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="n">N_k</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">vr</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rval</span><span class="p">):</span>
                <span class="n">nlvals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">bMaxLikelihood</span><span class="p">):</span>
            <span class="n">fitvals</span> <span class="o">=</span> <span class="n">MaxLikeParams</span><span class="p">(</span><span class="n">N_k</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">vr</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rval</span><span class="p">):</span>
                <span class="n">mlvals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitvals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bLinearFit</span> <span class="ow">and</span> <span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">Print1DStats</span><span class="p">(</span><span class="s1">&#39;Linear Fit Analysis&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">,[</span><span class="n">linvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">linvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">convertback</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">)</span>
        <span class="n">slopes</span> <span class="o">=</span> <span class="n">linvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
        <span class="n">dslope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
        <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">((</span><span class="n">slope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">dslope</span><span class="p">)]</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">bNonLinearFit</span> <span class="ow">and</span> <span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">Print1DStats</span><span class="p">(</span><span class="s1">&#39;Nonlinear Fit Analysis&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">,[</span><span class="n">nlvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nlvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">convertback</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">)</span>
        <span class="n">slopes</span> <span class="o">=</span> <span class="n">nlvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
        <span class="n">dslope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
        <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">((</span><span class="n">slope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dslope</span><span class="p">)]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bMaxLikelihood</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">check_twodtype</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="n">Print1DStats</span><span class="p">(</span><span class="s1">&#39;Maximum Likelihood Analysis&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">,[</span><span class="n">mlvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mlvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">convertback</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">)</span>
            <span class="n">slopes</span> <span class="o">=</span> <span class="n">nlvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
            <span class="n">dslope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
            <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;maxLikelihood&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">((</span><span class="n">slope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dslope</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="n">Print2DStats</span><span class="p">(</span><span class="s1">&#39;2D-Maximum Likelihood Analysis&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">,[</span><span class="n">mlvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mlvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">mlvals</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">kB</span><span class="p">,</span><span class="n">convertback</span><span class="p">,</span><span class="n">dp</span><span class="p">,</span><span class="n">const</span><span class="p">)</span>
            <span class="n">eneslopes</span> <span class="o">=</span> <span class="n">mlvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pvslopes</span> <span class="o">=</span> <span class="n">mlvals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">eneslope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">eneslopes</span><span class="p">)</span>
            <span class="n">deneslope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">deneslopes</span><span class="p">)</span>
            <span class="n">pvslope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">pvslopes</span><span class="p">)</span>
            <span class="n">dpvslope</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">dpvslopes</span><span class="p">)</span>
            <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;maxLikelihood&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">((</span><span class="n">eneslope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">deneslope</span><span class="p">),</span>
                                      <span class="nb">abs</span><span class="p">((</span><span class="n">pvslope</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">dpvslope</span><span class="p">)]</span>

    <span class="n">returnvalue</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">bMaxLikelihood</span><span class="p">:</span>
        <span class="n">returnvalue</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;maxLikelihood&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">bLinearFit</span><span class="p">:</span>
        <span class="n">returnvalue</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">bNonLinearFit</span><span class="p">:</span>
        <span class="n">returnvalue</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">returnvalue</span></div>
    
<span class="c1"># to do: fix the drawing directions so that correct data has the legend in the right place.</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Pascal T. Merz, Michael R. Shirts.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.9b',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>